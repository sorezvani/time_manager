{% load custom_filters %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>{{ project.name }} - Tasks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
    .popup-form-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .popup-form {
      background: white;
      padding: 20px 30px;
      border-radius: 10px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
    .popup-form textarea {
  resize: vertical; /* only vertical resize */
  max-height: 150px;
  overflow-y: auto;
}
    </style>

</head>
<body class="bg-light">

<div class="container mt-5">
    <h2>{{ project.name }} - Tasks</h2>

  <p class="text-muted">{{ project.description }}</p>

    
    <form method="post" id="project-state-form" class="mb-4 d-flex align-items-center gap-2">
      {% csrf_token %}
      <strong>Project State:</strong>
      <select name="project_state" class="form-select w-auto" id="project-state-select">
        {% for code, label in state_choices %}
          <option value="{{ code }}" {% if project.state == code %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </form>
    

<div class="d-flex justify-content-between align-items-start mb-4">
  <p class="mb-0" style="margin-top: 11px;"><strong>Total Duration:</strong> {{ project.total_duration }}</p>
  <button class="btn btn-success my-0" onclick="toggleTaskForm()">+ Add Task</button>
</div>



  {% if tasks %}
    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th>Name</th>
          <th>State</th>
          <th>Total Duration</th>
          <th>Change State</th>
          <th>Resume</th>
        </tr>
      </thead>
        <tbody>
          {% for task in tasks %}
            <tr>
              <td>
                <strong>{{ task.name }}</strong><br>
                <small class="text-muted">{{ task.description|default:"—" }}</small>
              </td>
              <td>
                <span class="badge 
                  {% if task.state == 'R' %} bg-success
                  {% elif task.state == 'N' %} bg-primary
                  {% elif task.state == 'E' %} bg-secondary
                  {% else %} bg-dark
                  {% endif %}">
                  {{ task.get_state_display }}
                </span>
              </td>
              <td>{{ task.total_duration }}</td>
              <td>
                <form method="post" class="d-flex align-items-center gap-2 task-state-form">
                  {% csrf_token %}
                  <input type="hidden" name="task_id" value="{{ task.id }}">
                  <select name="task_state" class="form-select form-select-sm w-auto auto-submit-select">
                    {% for code, label in state_choices %}
                      <option value="{{ code }}" {% if task.state == code %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </form>
              </td>
              <td>
                <form action="{% url 'task_resume' task.id %}" method="get">
                  <button type="submit" class="btn btn-sm btn-outline-primary">Resume</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
    </table>
  {% else %}
    <p class="text-muted">No tasks for this project.</p>
  {% endif %}

  <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-primary mt-4">← Back to Dashboard</a>


<!-- Popup container -->
<div id="taskFormContainer" class="popup-form-container" style="display: none;">
  <div class="popup-form">
    <h5 class="text-center mb-4">Add New Task</h5>
    <form method="post" style="width: 100%;">
      {% csrf_token %}
      <input type="hidden" name="add_task" value="1">

      <div class="form-group mb-3 text-center">
        {{ task_form.name.label_tag }}
        {{ task_form.name|add_class:"form-control text-center" }}
      </div>

      <div class="form-group mb-3 text-center">
        {{ task_form.state.label_tag }}
        {{ task_form.state|add_class:"form-select text-center" }}
      </div>

      <div class="form-group mb-4">
        {{ task_form.description.label_tag }}
        {{ task_form.description|add_class:"form-control"}}
      </div>

      <div class="d-flex justify-content-between">
        <button type="submit" class="btn btn-primary w-50">Create</button>
        <button type="button" class="btn btn-outline-secondary w-50 ms-2" onclick="toggleTaskForm()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
function toggleTaskForm() {
  const container = document.getElementById('taskFormContainer');
  container.style.display = (container.style.display === 'none' || container.style.display === '') ? 'flex' : 'none';
}
</script>

<script>
  // Auto-submit project state form
  document.getElementById('project-state-select').addEventListener('change', function() {
    document.getElementById('project-state-form').submit();
  });

  // Auto-submit task state forms
  document.querySelectorAll('.auto-submit-select').forEach(function(select) {
    select.addEventListener('change', function() {
      this.form.submit();
    });
  });

</script>
</body>
</html>
